# Decision Server Quarkus Microservice

## Overview  
This server was generated by the  project.

## Install Decision Service library
To be able to run decision quarkus micro service you should install library in your local or remote repository.

```bash
mvn initialize -Pinstall-libs

[INFO] Scanning for projects...
[WARNING]
[WARNING] Some problems were encountered while building the effective model for decisionservice:Shipment_Pricing:jar:1.0
[WARNING] 'build.plugins.plugin.version' for org.apache.maven.plugins:maven-install-plugin is missing. @ line 176, column 19
[WARNING]
[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.
[WARNING]
[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.
[WARNING]
[INFO]
[INFO] ------------------< decisionservice:Shipment_Pricing >------------------
[INFO] Building Shipment_Pricing 1.0
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- maven-install-plugin:2.4:install-file (j2ee-connector-lib) @ Shipment_Pricing ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/Shipment/lib/j2ee_connector-1_5-fr.jar to /Users/laurentgrateau/.m2/repository/j2ee_connector/j2ee_connector/1.0.0/j2ee_connector-1.0.0.jar
[INFO]
[INFO] --- maven-install-plugin:2.4:install-file (jrules-res-execution-lib) @ Shipment_Pricing ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/Shipment/lib/jrules-res-execution.jar to /Users/laurentgrateau/.m2/repository/jrules-res-execution/jrules-res-execution/1.0.0/jrules-res-execution-1.0.0.jar
[INFO]
[INFO] --- maven-install-plugin:2.4:install-file (jrules-res-manage-tools-lib) @ Shipment_Pricing ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/Shipment/lib/jrules-res-manage-tools.jar to /Users/laurentgrateau/.m2/repository/jrules-res-manage-tool/jrules-res-manage-tool/1.0.0/jrules-res-manage-tool-1.0.0.jar
[INFO]
[INFO] --- maven-install-plugin:2.4:install-file (jrules-engine-lib) @ Shipment_Pricing ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/Shipment/lib/jrules-engine.jar to /Users/laurentgrateau/.m2/repository/jrules-engine/jrules-engine/1.0.0/jrules-engine-1.0.0.jar
[INFO]
[INFO] --- maven-install-plugin:2.4:install-file (xom-lib) @ Shipment_Pricing ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/Shipment/lib/xom.jar to /Users/laurentgrateau/.m2/repository/xom/xom/1.0.0/xom-1.0.0.jar
[INFO]
[INFO] --- maven-install-plugin:2.4:install-file (ruleapp-lib) @ Shipment_Pricing ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/Shipment/lib/ruleapp.jar to /Users/laurentgrateau/.m2/repository/ruleApp/ruleApp/1.0.0/ruleApp-1.0.0.jar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  1.198 s
[INFO] Finished at: 2022-12-08T16:55:56+01:00
[INFO] ------------------------------------------------------------------------
```

Once you have install the required library you are able to run the decision service in different ways:
   - Locally in the Quarkus dev environment
   - Generate a Docker image and run it  in your machine
   - Deploy your code in Openshift
   - Deploy your code in Kubernetes

## Run this code locally with Java
```bash
mvn quarkus:dev
```

## Run this code locally with Docker
### Install the docker extension

```bash
mvn  quarkus:add-extension -Dextensions='container-image-docker'
```

### Build the Decision Service docker image

```bash
mvn install -Dquarkus.container-image.build=true
....
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #8 sha256:655230e70e3e6934ad84d20d94ca9c29b61e706f1eb54fcf272b6bded97a81ad
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #8 DONE 0.0s
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor]
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #9 [5/5] COPY --chown=185 target/quarkus-app/quarkus/ /deployments/quarkus/
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #9 sha256:93cadb62f726a5a81855b930b76d358f04caaf851b1a95a1d4b755a72e5550c3
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #9 DONE 0.0s
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor]
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting to image
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 sha256:e8c613e07b0b7ff33893b694f7759a10d42e180f2b4dc349fb57dc6b71dcab00
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting layers
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting layers 0.3s done
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 writing image sha256:6e08bdedd3878b19649844363763f0c223fa0a7921f38625580c125cc6104124 done
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 naming to docker.io/laurentgrateau/shipmentpricing:1.0 done
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 DONE 0.3s
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor]
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] Built container image decisionservice/shipmentpricing:1.0 (null)
```


You can find more informations in the Quarkus Docker extension [documentation](https://quarkus.io/guides/container-image)

### Run the Decision Service docker image
```bash
docker run -p 8080:8080 decisionservice/{{rulesetArtifactName}}:{{rulesetVersion}}
```


### Deploy the Decision Service in OpenShift


## Run this code in Openshift
### Install Openshift extension

```bash
mvn quarkus:add-extension -Dextensions='openshift'
```

> Note : If you already install kubernetes and/or docker extension you should remove it to use openshift extension.
> mvn quarkus:remove-extension -Dextensions='docker,kubernetes'

### Log Into the OpenShift Cluster

Before we build and deploy our application we need to log into an OpenShift cluster.

#### Log In - OpenShift CLI With API Token Example

```bash
oc login --token=myToken --server=myServerUrl
```
You can request the token via the Copy Login Command link in the OpenShift web console.

Finally, you donâ€™t need to use the OpenShift CLI at all. Instead, set the quarkus.kubernetes-client.master-url config property and authenticate with the quarkus.kubernetes-client.token, or quarkus.kubernetes-client.username and quarkus.kubernetes-client.password respectively:

```bash
mvn install -Dquarkus.kubernetes-client.master-url=myServerUrl -Dquarkus.kubernetes-client.token=myToken
```

### Deploy the Decision Service in OpenShift

```bash
mvn install -Dquarkus.kubernetes.deploy=true  -Dquarkus.openshift.route.expose=true
...
[INFO] [io.quarkus.container.image.openshift.deployment.OpenshiftProcessor] Push successful
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Deploying to openshift server: https://api.odm-dev-ocp410.cp.fyre.ibm.com:6443/ in namespace: default.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: DeploymentConfig miniloanrules.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream miniloanrules.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: ImageStream openjdk-11.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Service miniloanrules.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: Route miniloanrules.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] Applied: BuildConfig miniloanrules.
[INFO] [io.quarkus.kubernetes.deployment.KubernetesDeployer] The deployed application can be accessed at: http://miniloanrules-default.apps.odm-dev-ocp410.cp.fyre.ibm.com
[INFO] [io.quarkus.deployment.QuarkusAugmentor] Quarkus augmentation completed in 41711ms
[INFO]
[INFO] --- maven-failsafe-plugin:3.0.0-M7:integration-test (default) @ miniloanrules ---
[INFO] Tests are skipped.
[INFO]
[INFO] --- maven-failsafe-plugin:3.0.0-M7:verify (default) @ miniloanrules ---
[INFO] Tests are skipped.
[INFO]
[INFO] --- maven-install-plugin:2.4:install (default-install) @ miniloanrules ---
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/openshift/target/miniloanrules-1.0.jar to /Users/laurentgrateau/.m2/repository/decisionservice/miniloanrules/1.0/miniloanrules-1.0.jar
[INFO] Installing /Users/laurentgrateau/Work/product/proto/icp/knative/decision-microservice/openshift/pom.xml to /Users/laurentgrateau/.m2/repository/decisionservice/miniloanrules/1.0/miniloanrules-1.0.pom
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  47.654 s
[INFO] Finished at: 2022-12-08T16:38:59+01:00
[INFO] ------------------------------------------------------------------------
```

> Notes: If you encountered cert issue add this parameter in the cmd line. -Dquarkus.kubernetes-client.trust-certs=true


You can find more informations in the Quarkus OpenShift extension [documentation](https://quarkus.io/guides/deploying-to-openshift)

### Access the Decision Microservice
```bash
oc get routes
NAME              HOST/PORT                                                     PATH   SERVICES          PORT   TERMINATION   WILDCARD
miniloanrules     miniloanrules-default.apps.odm-dev-ocp410.cp.fyre.ibm.com            miniloanrules     http                 None
```

Open a web browser to 'http://miniloanrules-default.apps.odm-dev-ocp410.cp.fyre.ibm.com'

## Run this code in Kubernetes